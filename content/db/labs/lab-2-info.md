---
title: Доп теоретия к лабое 1
draft: false
created: 2024-09-27T12:48
tags:
---

## GROUP BY

В SQL оператор `GROUP BY` используется для группировки строк по одному или нескольким столбцам. Он объединяет строки, которые имеют одинаковые значения в указанных столбцах, и позволяет выполнять агрегатные функции (например, `COUNT`, `SUM`, `AVG`, `MAX`, `MIN`) для каждой группы. Рассмотрим все возможные варианты использования `GROUP BY`.

### 1. **Группировка по одному столбцу**

Этот вариант используется для группировки строк на основе значений одного столбца.

Пример:

```sql
SELECT department, COUNT(*)
FROM employees
GROUP BY department;
```

В этом запросе строки сгруппированы по отделу, и для каждого отдела выводится количество сотрудников.

### 2. **Группировка по нескольким столбцам**

Можно группировать строки по комбинации нескольких столбцов. В этом случае группы создаются на основе всех перечисленных столбцов.

Пример:

```sql
SELECT department, job_title, COUNT(*)
FROM employees
GROUP BY department, job_title;
```

Здесь строки группируются сначала по отделу, а затем по должности внутри каждого отдела. Для каждой такой группы считается количество сотрудников.

### 3. **Группировка с использованием агрегатных функций**

`GROUP BY` часто используется вместе с агрегатными функциями для получения агрегированных данных, например суммы, среднего, максимального значения и т.д.

Пример:

```sql
SELECT department, AVG(salary)
FROM employees
GROUP BY department;
```

Этот запрос выводит среднюю зарплату для каждого отдела.

### 4. **Группировка с фильтрацией до и после агрегирования (`WHERE` и `HAVING`)**

Как обсуждалось ранее, можно использовать `WHERE` для фильтрации строк до группировки и `HAVING` для фильтрации результатов после выполнения агрегатных операций.

Пример:

```sql
SELECT department, AVG(salary)
FROM employees
WHERE salary > 30000
GROUP BY department
HAVING AVG(salary) > 50000;
```

Здесь `WHERE` фильтрует строки с зарплатой выше 30 000, после чего данные группируются по отделам, а `HAVING` отбирает только те отделы, где средняя зарплата превышает 50 000.

### 5. **Группировка с сортировкой (`ORDER BY`)**

После выполнения группировки можно отсортировать результаты с помощью `ORDER BY`, как по группированным полям, так и по агрегатным функциям.

Пример:

```sql
SELECT department, COUNT(*) as employee_count
FROM employees
GROUP BY department
ORDER BY employee_count DESC;
```

В данном примере группы отсортированы по количеству сотрудников в отделах, начиная с наибольшего значения.

### 6. **Группировка с использованием алиасов (псевдонимов)**

Если в запросе используются алиасы (псевдонимы столбцов), `GROUP BY` должен ссылаться на оригинальные имена столбцов, а не на псевдонимы.

Пример:

```sql
SELECT department, COUNT(*) as total_employees
FROM employees
GROUP BY department;
```

Здесь `GROUP BY` ссылается на оригинальное имя столбца `department`, а не на алиас `total_employees`.

### 7. **Группировка с функцией `ROLLUP`**

`ROLLUP` используется для создания подытогов (суммарных значений) на нескольких уровнях. Он добавляет дополнительные строки в результат, показывая агрегаты для каждой группы и их общую сумму.

Пример:

```sql
SELECT department, job_title, SUM(salary)
FROM employees
GROUP BY ROLLUP (department, job_title);
```

Этот запрос создаст подытоги для каждой должности внутри отдела, а также общий итог для каждого отдела и всех отделов в целом.

### 8. **Группировка с функцией `CUBE`**

Функция `CUBE` создает агрегаты для всех возможных комбинаций значений столбцов, указанных в `GROUP BY`.

Пример:

```sql
SELECT department, job_title, SUM(salary)
FROM employees
GROUP BY CUBE (department, job_title);
```

`CUBE` создаст агрегаты для каждой комбинации (например, для отдела, должности и их комбинаций) и общий итог для всех сотрудников.

### 9. **Группировка с функцией `GROUPING SETS`**

Функция `GROUPING SETS` позволяет задавать несколько наборов группировок, что даёт больше гибкости при создании агрегатов.

Пример:

```sql
SELECT department, job_title, SUM(salary)
FROM employees
GROUP BY GROUPING SETS (
    (department),
    (job_title),
    (department, job_title)
);
```

Этот запрос создаст агрегаты для каждого отдела, каждой должности, а также их комбинаций.

### Итог

Оператор `GROUP BY` может быть использован как с простыми группировками по одному столбцу, так и с более сложными операциями, такими как подытоги и комбинации группировок (`ROLLUP`, `CUBE`, `GROUPING SETS`).
